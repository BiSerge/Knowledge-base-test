<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<html><head><meta name="qrichtext" content="1" /><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><style type="text/css">
p, li { white-space: pre-wrap; }
</style></head><body style=" font-family:'MS Shell Dlg 2'; font-size:10pt; font-weight:400; font-style:normal;">
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Lucida Sans Unicode,Lucida Grande,sans-serif'; font-size:xx-large; color:#444444; background-color:#000000;">Восстановление баз данных SQL Server 2005/2008</span></p>
<p style=" margin-top:0px; margin-bottom:26px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; font-style:italic; color:#999999; background-color:#000000;">Опубликовано в </span><a href="http://notesit.ru/db/mssql-db/vosstanovlenie-baz-dannyx-sql-server-2005-2008"><span style=" font-family:'Verdana,Geneva,sans-serif'; font-style:italic; text-decoration: underline; color:#28a3c2; background-color:#000000;">9 Август 2011</span></a><span style=" font-family:'Verdana,Geneva,sans-serif'; font-style:italic; color:#999999; background-color:#000000;"> автором </span><a href="http://notesit.ru/author/shah"><span style=" font-family:'Verdana,Geneva,sans-serif'; font-style:italic; text-decoration: underline; color:#28a3c2; background-color:#000000;">zet</span></a></p>
<p style=" margin-top:0px; margin-bottom:21px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">MS SQL Server поддерживает три различных вида резервных копий – полную (full backup), дифференциальную(differential backup) и резервную копию журнала транзакций (transaction log backup). Первые два вида резервных копий доступны для баз данных в любой модели восстановления, резервная копия журнала транзакций – для баз данных в модели восстановления FULL и BULK-LOGGED (про модели восстановления вы можете прочитать здесь http://msdn.microsoft.com/ru-ru/library/aa196685(v=SQL.80).aspx ).</span></p>
<p style=" margin-top:0px; margin-bottom:21px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">Расскажу про вариант восстановления из полной резервной копии (он работает для всех моделей восстановления). Здесь все просто – необходимо выполнить T-SQL скрипт:</span></p>
<pre style=" margin-top:21px; margin-bottom:21px; margin-left:21px; margin-right:21px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'monospace,sans-serif'; color:#444444; background-color:#000000;">RESTORE DATABASE [имя_базы_данных] FROM DISK = 'путь к полной резервной копии'. WITH REPLACE, RECOVERY, STATS = 10 MOVE 'имя_базы_данных_Data' TO 'путь_к_базе_на_диске\имя_базы_данных_data.mdf', MOVE 'имя_базы_данных_Log' TO 'путь_к_базе_на_диске\имя_базы_данных_log.ldf'</span></pre>
<p style=" margin-top:0px; margin-bottom:21px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">Параметр REPLACE указывает на то, что если база данных с именем [имя_базы_данных] существует, то мы заменяем ее содержимое содержимым резервной копии. Если вы восстанавливаете базу данных с помощью GUI – нужно указать «Overwrite the existing database» на вкладке «Options». RECOVERY говорит о том, что базу данных необходимо перевести в согласованное состояние и разрешить соединения пользователей. В GUI это соответствует опции «Leave the database ready to use by rolling back uncommitted transactions. Additional transaction logs cannot be restored.». Т.е., SQL Server откатывает все незафиксированные транзакции и позволяет пользователям работать с данными. После того как вы восстановили резервную копию с параметром RECOVERY, к ней нельзя применять дополнительно копии журналов транзакций и дифференциальные копии. Будьте внимательны, этот параметр устанавливается по умолчанию и если вы захотите «накатить» еще одну копию – процесс восстановления придется начать заново.</span></p>
<p style=" margin-top:0px; margin-bottom:21px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">STATS = 10 отвечает за вывод информации о процессе восстановления. В данном случае, при восстановлении каждых 10 % резервной копии, на вкладке Messages в SSMS будет появляться сообщение. При восстановлении с помощью GUI вы не можете управлять этим параметром – за изменениями можно следить на «графике» в нижнем левом углу.</span></p>
<p style=" margin-top:0px; margin-bottom:21px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">Последние две строчки нужны, если Вам нужно восстановить базу не в путь по умолчанию. По умолчанию копия восстанавливается в то же самое место откуда она была сделана. Т.е. если изначально все файлы базы данных лежали в каталоге C:\Database, а вы хотите восстановить копию в другое место, то необходимо использовать параметр MOVE. Для использования MOVE вам необходимо знать логические имена файлов – их можно посмотреть с помощью представления sys.database_files. Вот пример использования этого представления:</span><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444;"><br /></span></p>
<pre style=" margin-top:21px; margin-bottom:21px; margin-left:21px; margin-right:21px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'monospace,sans-serif'; color:#444444;"><br /> use [имя_базы_данных]<br /> SELECT name, physical_name FROM sys.database_files<br /> </span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444;"><br />Если база данных осталась в состоянии RESTORING, ее можно привести в работоспособное состояние и без резервных копий:</span></p>
<pre style=" margin-top:21px; margin-bottom:21px; margin-left:21px; margin-right:21px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'monospace,sans-serif'; color:#444444; background-color:#000000;">RESTORE DATABASE [имя_базы_данных] WITH RECOVERY</span></pre>
<p style=" margin-top:0px; margin-bottom:0px; margin-left:0px; margin-right:0px; -qt-block-indent:0; text-indent:0px; background-color:#000000;"><span style=" font-family:'Verdana,Geneva,sans-serif'; color:#444444; background-color:#000000;">После этого база данных «вернется к жизни».</span></p></body></html>